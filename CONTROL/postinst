#!/bin/sh

# **************************************
# Softcam Manager - Post-Installation Script
# **************************************

LINE="======================================================================="

echo "$LINE"
echo "Softcam Manager - Installation Complete"
echo "$LINE"

# Crea directory necessarie
echo "Creating necessary directories..."
for dir in "/usr/keys" "/usr/camscript" "/tmp/softcam_backups"; do
    if [ ! -d "$dir" ]; then
        mkdir -p "$dir" 2>/dev/null
        if [ $? -eq 0 ]; then
            echo "âœ“ Created: $dir"
        else
            echo "âš  Failed to create: $dir"
        fi
    else
        echo "âœ“ Already exists: $dir"
    fi
done

# Imposta permessi
echo "Setting permissions..."
chmod 755 /usr/camscript/ 2>/dev/null
chmod 755 /usr/keys/ 2>/dev/null

# Crea file di configurazione base se non esistono
echo "Creating default configuration files..."
if [ ! -f "/etc/clist.list" ]; then
    touch "/etc/clist.list"
    chmod 644 "/etc/clist.list"
    echo "âœ“ Created: /etc/clist.list"
fi

if [ ! -f "/etc/startcam.sh" ]; then
    cat > "/etc/startcam.sh" << 'EOF'
#!/bin/sh
# Auto-generated by Softcam Manager
# This file will be populated when a softcam is started
echo "No softcam configured"
EOF
    chmod 755 "/etc/startcam.sh"
    echo "âœ“ Created: /etc/startcam.sh"
fi

# Verifica e installa wget se necessario
echo "Checking for wget..."
if command -v wget >/dev/null 2>&1; then
    echo "âœ“ wget is available"
else
    echo "Installing wget..."
    if command -v apt-get >/dev/null 2>&1; then
        apt-get update >/dev/null 2>&1
        apt-get install -y wget >/dev/null 2>&1
    elif command -v opkg >/dev/null 2>&1; then
        opkg update >/dev/null 2>&1
        opkg install wget >/dev/null 2>&1
    fi
    
    if command -v wget >/dev/null 2>&1; then
        echo "âœ“ wget installed successfully"
    else
        echo "âš  Failed to install wget"
    fi
fi

# Scarica e installa aggiornamenti opzionali
echo "Checking for optional updates..."
if command -v wget >/dev/null 2>&1; then
    echo "Downloading latest configuration..."
    wget -q --no-check-certificate --timeout=30 --tries=2 \
         "https://raw.githubusercontent.com/Belfagor2005/tvManager/main/installer.sh" -O - | /bin/sh >/dev/null 2>&1
    
    if [ $? -eq 0 ]; then
        echo "âœ“ Optional updates applied"
    else
        echo "âš  Optional updates failed (network issue or unavailable)"
    fi
else
    echo "âš  Skipping updates (wget not available)"
fi

# Verifica installazione plugin
echo "Verifying plugin installation..."
PLUGIN_DIR="/usr/lib/enigma2/python/Plugins/Extensions/tvManager/"
if [ -d "$PLUGIN_DIR" ] && [ -f "${PLUGIN_DIR}plugin.py" ]; then
    echo "âœ“ Plugin files verified"
else
    echo "âœ— Plugin installation incomplete"
    echo "Please check the installation logs"
fi

echo "$LINE"
echo "ðŸŽ‰ Softcam Manager Installation Successful!"
echo "$LINE"
echo ""
echo "ðŸ“‹ Next Steps:"
echo "   1. Restart Enigma2 to activate the plugin"
echo "   2. Access via: Menu -> Plugins -> Softcam Manager"
echo "   3. Download softcams from the built-in repository"
echo ""
echo "ðŸ”§ Features:"
echo "   â€¢ Multiple softcam support (OSCam, CCcam, NCam)"
echo "   â€¢ One-click installation and management"
echo "   â€¢ Resource monitoring"
echo "   â€¢ Backup and restore configurations"
echo ""
echo "âš  IMPORTANT: Restart Enigma2 to complete installation!"
echo "$LINE"

exit 0
