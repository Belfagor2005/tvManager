#!/bin/bash
#### "***********************************************"
#### "*                 Created By Levi45            *"
#### "***********************************************"

# Configuration - PATHS ADAPTED FOR ENIGMA2
OSCAM_FILE="/etc/tuxbox/config/oscam.server"
BACKUP_DIR="/tmp/oscam_backups"
BACKUP_FILE="$BACKUP_DIR/oscam.server.backup_$(date +%Y%m%d_%H%M%S)"
LOG_FILE="/tmp/oscam_update.log"
TEMP_FILE="/tmp/oscam_temp"
# KEYS_URL="https://0g.gg/?dd6ef61ca87810fd#6tLnCmx2a7ZqijWddspjEwDGW6ZGtLdKQzJvLMTy3Xr9"
KEYS_URL="https://raw.githubusercontent.com/levi-45/tivusatrsakey/main/rsakey_tiger.txt"

# Hardcoded current keys (YOUR COMPLETE KEYS)
CURRENT_KEYS=$(cat << 'EOF'
rsakey                        = A22DE56CA2560B596E4B76DDFD1CFE7528F696E229B3A88B60CE6250287FBC0F62F62485D3FD8DA69B2C3C5B8A9E859608BB56169A0445180951D9F85EBC4D3EFA7F3B6181DDA069D6657B38A79784CD63AB8BAE9B9CADB48632E86600D7FC5D
rsakey_tiger                  = A22DE56CA2560B596E4B76DDFD1CFE7528F696E229B3A88B60CE6250287FBC0F62F62485D3FD8DA69B2C3C5B8A9E859608BB56169A0445180951D9F85EBC4D3EFA7F3B6181DDA069D6657B38A79784CD63AB8BAE9B9CADB48632E86600D7FC5D
tiger_save_emm                = 0
tiger_round_keys              = 3EA3BD0C849DFD990DFD37D24F7F42C15A8B3ED2E2DDBB5908218E16E0DAE1DD4BE7B5837D2D8876CBC6416620B47F63A547F9383DA948ECD61CCA32786F0F7B23D0D83100CECE192956A27E295E40A9DE342F8EEB12A4065EEA757A6326A67A
tiger_t0                      = BA5D5DE745DEDE9B0000000097B7B7205FD3D38C6DCACAA7783C3C441A0D0D177FC3C3BC09F8F8F16FCBCBA4E38D8D6EEC76769AEB898962ADAAAA0724121236E9888861442222669E4F4FD14FDBDB94DA6D6DB78E4747C931E4E4D5984C4CD4F0787888CD9A9A57924949DBDF93934C71C4C4B579C0C0B9F586867326131335ABA9A90240202060A65353F5381C1C249C4E4ED267CFCFA86A35355F7239394B91B4B425BBA1A11AA85454FCC86464AC0603030577C7C7B0F3858576B85C5CE4B65B5BED63CDCDAE49D8D891E4727296D5969643844242C689B8B8313BE1E1DABDA2A21FC06060A027EFEFC883BDBD3E04020206A7AFAF08E18C8C6DE6737395F87C7C84FE7F7F81BC5E5EE20BF9F9F2CA6565AF35E6E6D32FEBEBC4A3ADAD0EB45A5AEEB3A5A516F279798BE58E8E6B2A15153F6030305021ECECCDB1A4A4157DC2C2BF7C3E3E4239E0E0D9E874749CA25151F30FFBFBF45A2D2D77DC6E6EB2D19494459A4D4DD7AA5555FF6834345CA5AEAE0BA45252F6FC7E7E82C39D9D5E944A4ADE17F7F7E0F980807919F0F0E959D0D089D9909049B7A7A71029E8E8C1C79F9F58A05050F053D5D5865BD1D18AC998985161CCCCADB9A0A0192E17173911F4F4E595B6B6237BC1C1BA50282878BE5F5FE14C26266A02010103AFABAB044A25256F70383848FD82827FFA7D7D87904848D801FCFCFD361B1B2D65CECEAB7E3F3F41D66B6BBD3DE2E2DFCE6767A9CC6666AA864343C5B25959EB3219192BF18484757A3D3D4713F5F5E65E2F2F716BC9C9A281BCBC3D4BD9D992D39595465229297B824141C34DDADA97341A1A2E99B0B0292BE9E9C2D26969BB5DD2D28FF67B7B8D57D7D78022111133CF9B9B5466333355ED8A8A67462323651209091B51D4D485E2717193884444CCD06868B8DE6F6FB11DF2F2EF1C0E0E1247DFDF98F787877041DCDC9DFF83837C30181828D46A6ABE25EEEECBCB999952FB81817AC46262A66C36365A5C2E2E72F47A7A8E05FEFEFB8A4545CFC19C9C5DEA75759FDB91914A180C0C141E0F0F1137E7E7D015F6F6E32814143CC66363A53A1D1D27160B0B1DEF8B8B649FB3B32C1FF3F3EC9DB2B22F763B3B4D10080818964B4BDD20101030B5A6A613643232568BB9B932A9A8A801DD92924F1BF1F1EAAC5656FA43DDDD9E4221216387BFBF380804040C85BEBE3B55D6D68303FDFDFEEE7777992DEAEAC7743A3A4E69C8C8A1E78F8F68AE5757F93C1E1E220DFAFAF7562B2B7DB05858E873C5C5B64E272769A1ACAC0D3FE3E3DC23EDEDCED79797408FBBBB348C4646CA0A05050F804040C06231315333E5E5D66E373759582C2C74C59E9E5B140A0A1E9BB1B12A93B5B5260C06060AD86C6CB43E1F1F21BFA3A31C542A2A7EE070709007FFFFF88DBABA370E0707094824246C2C16163A75C6C6B3C26161A3
tiger_t1                      = 5D5DE7BADEDE9B4500000000B7B72097D3D38C5FCACAA76D3C3C44780D0D171AC3C3BC7FF8F8F109CBCBA46F8D8D6EE376769AEC898962EBAAAA07AD12123624888861E9222266444F4FD19EDBDB944F6D6DB7DA4747C98EE4E4D5314C4CD498787888F09A9A57CD4949DB9293934CDFC4C4B571C0C0B979868673F513133526A9A902AB202060405353F5A61C1C24384E4ED29CCFCFA86735355F6A39394B72B4B42591A1A11ABB5454FCA86464ACC803030506C7C7B077858576F35C5CE4B85B5BEDB6CDCDAE63D8D89149727296E4969643D54242C684B8B83189E1E1DA3BA2A21FBD6060A0C0EFEFC827BDBD3E8302020604AFAF08A78C8C6DE1737395E67C7C84F87F7F81FE5E5EE2BCF9F9F20B6565AFCAE6E6D335EBEBC42FADAD0EA35A5AEEB4A5A516B379798BF28E8E6BE515153F2A30305060ECECCD21A4A415B1C2C2BF7D3E3E427CE0E0D93974749CE85151F3A2FBFBF40F2D2D775A6E6EB2DC949445D14D4DD79A5555FFAA34345C68AEAE0BA55252F6A47E7E82FC9D9D5EC34A4ADE94F7F7E017808079F9F0F0E919D0D08959909049D9A7A710B7E8E8C1299F9F58C75050F0A0D5D58653D1D18A5B989851C9CCCCAD61A0A019B91717392EF4F4E511B6B62395C1C1BA7B282878505F5FE1BE26266A4C01010302ABAB04AF25256F4A3838487082827FFD7D7D87FA4848D890FCFCFD011B1B2D36CECEAB653F3F417E6B6BBDD6E2E2DF3D6767A9CE6666AACC4343C5865959EBB219192B32848475F13D3D477AF5F5E6132F2F715EC9C9A26BBCBC3D81D9D9924B959546D329297B524141C382DADA974D1A1A2E34B0B02999E9E9C22B6969BBD2D2D28F5D7B7B8DF6D7D78057111133229B9B54CF333355668A8A67ED2323654609091B12D4D48551717193E24444CC886868B8D06F6FB1DEF2F2EF1D0E0E121CDFDF9847878770F7DCDC9D4183837CFF181828306A6ABED4EEEECB25999952CB81817AFB6262A6C436365A6C2E2E725C7A7A8EF4FEFEFB054545CF8A9C9C5DC175759FEA91914ADB0C0C14180F0F111EE7E7D037F6F6E31514143C286363A5C61D1D273A0B0B1D168B8B64EFB3B32C9FF3F3EC1FB2B22F9D3B3B4D76080818104B4BDD9610103020A6A613B532325664B9B9328BA8A801A992924FDDF1F1EA1B5656FAACDDDD9E4321216342BFBF388704040C08BEBE3B85D6D68355FDFDFE03777799EEEAEAC72D3A3A4E74C8C8A1698F8F68E75757F9AE1E1E223CFAFAF70D2B2B7D565858E8B0C5C5B6732727694EACAC0DA1E3E3DC3FEDEDCE23979740D7BBBB348F4646CA8C05050F0A4040C08031315362E5E5D6333737596E2C2C74589E9E5BC50A0A1E14B1B12A9BB5B5269306060A0C6C6CB4D81F1F213EA3A31CBF2A2A7E54707090E0FFFFF807BABA378D0707090E24246C4816163A2CC6C6B3756161A3C2
tiger_t2                      = E7BA5D5D9B45DEDE000000002097B7B78C5FD3D3A76DCACA44783C3C171A0D0DBC7FC3C3F109F8F8A46FCBCB6EE38D8D9AEC767662EB898907ADAAAA3624121261E9888866442222D19E4F4F944FDBDBB7DA6D6DC98E4747D531E4E4D5984C4C88F0787857CD9A9ADB9249494CDF9393B571C4C4B979C0C073F586863526131302ABA9A960402020F5A6535324381C1CD29C4E4EA867CFCF5F6A35354B7239392591B4B41ABBA1A1FCA85454ACC8646405060303B077C7C776F38585E4B85C5CEDB65B5BAE63CDCD9149D8D896E4727243D59696C68442423189B8B8DA3BE1E11FBDA2A2A0C06060C827EFEF3E83BDBD0604020208A7AFAF6DE18C8C95E6737384F87C7C81FE7F7FE2BC5E5EF20BF9F9AFCA6565D335E6E6C42FEBEB0EA3ADADEEB45A5A16B3A5A58BF279796BE58E8E3F2A151550603030CD21ECEC15B1A4A4BF7DC2C2427C3E3ED939E0E09CE87474F3A25151F40FFBFB775A2D2DB2DC6E6E45D19494D79A4D4DFFAA55555C6834340BA5AEAEF6A4525282FC7E7E5EC39D9DDE944A4AE017F7F779F98080E919F0F08959D0D049D9909010B7A7A7C129E8E858C79F9FF0A050508653D5D58A5BD1D151C99898AD61CCCC19B9A0A0392E1717E511F4F42395B6B6BA7BC1C178502828E1BE5F5F6A4C26260302010104AFABAB6F4A2525487038387FFD828287FA7D7DD8904848FD01FCFC2D361B1BAB65CECE417E3F3FBDD66B6BDF3DE2E2A9CE6767AACC6666C5864343EBB259592B32191975F18484477A3D3DE613F5F5715E2F2FA26BC9C93D81BCBC924BD9D946D395957B522929C3824141974DDADA2E341A1A2999B0B0C22BE9E9BBD269698F5DD2D28DF67B7B8057D7D73322111154CF9B9B5566333367ED8A8A654623231B1209098551D4D485E27171CC884444B8D06868B1DE6F6FEF1DF2F2121C0E0E9847DFDF70F787879D41DCDC7CFF838328301818BED46A6ACB25EEEE52CB99997AFB8181A6C462625A6C3636725C2E2E8EF47A7AFB05FEFECF8A45455DC19C9C9FEA75754ADB919114180C0C111E0F0FD037E7E7E315F6F63C281414A5C66363273A1D1D1D160B0B64EF8B8B2C9FB3B3EC1FF3F32F9DB2B24D763B3B18100808DD964B4B3020101013B5A6A656643232328BB9B901A9A8A84FDD9292EA1BF1F1FAAC56569E43DDDD634221213887BFBF0C0804043B85BEBE8355D6D6FE03FDFD99EE7777C72DEAEA4E743A3AA169C8C868E78F8FF9AE5757223C1E1EF70DFAFA7D562B2BE8B05858B673C5C5694E27270DA1ACACDC3FE3E3CE23EDED40D79797348FBBBBCA8C46460F0A0505C080404053623131D633E5E5596E373774582C2C5BC59E9E1E140A0A2A9BB1B12693B5B50A0C0606B4D86C6C213E1F1F1CBFA3A37E542A2A90E07070F807FFFF378DBABA090E07076C4824243A2C1616B375C6C6A3C26161
tiger_t3                      = 5DE7BA5DDE9B45DE00000000B72097B7D38C5FD3CAA76DCA3C44783C0D171A0DC3BC7FC3F8F109F8CBA46FCB8D6EE38D769AEC768962EB89AA07ADAA123624128861E988226644224FD19E4FDB944FDB6DB7DA6D47C98E47E4D531E44CD4984C7888F0789A57CD9A49DB9249934CDF93C4B571C4C0B979C08673F58613352613A902ABA92060402053F5A6531C24381C4ED29C4ECFA867CF355F6A35394B7239B42591B4A11ABBA154FCA85464ACC86403050603C7B077C78576F3855CE4B85C5BEDB65BCDAE63CDD89149D87296E4729643D59642C68442B83189B8E1DA3BE1A21FBDA260A0C060EFC827EFBD3E83BD02060402Af08A7AF8C6DE18C7395E6737C84F87C7F81FE7F5EE2BC5EF9F20BF965AFCA65E6D335E6EBC42FEBAD0EA3AD5AEEB45AA516B3A5798BF2798E6BE58E153F2A1530506030ECCD21ECA415B1A4C2BF7DC23E427C3EE0D939E0749CE87451F3A251FBF40FFB2D775A2D6EB2DC6E9445D1944DD79A4D55FFAA55345C6834AE0BA5AE52F6A4527E82FC7E9D5EC39D4ADE944AF7E017F78079F980F0E919F0D08959D09049D990A710B7A7E8C129E89F58C79F50F0A050D58653D5D18A5BD19851C998CCAD61CCA019B9A017392E17F4E511F4B62395B6C1BA7BC1287850285FE1BE5F266A4C2601030201AB04AFAB256F4A2538487038827FFD827D87FA7D48D89048FCFD01FC1B2D361BCEAB65CE3F417E3F6BBDD66BE2DF3DE267A9CE6766AACC6643C5864359EBB259192B32198475F1843D477A3DF5E613F52F715E2FC9A26BC9BC3D81BCD9924BD99546D395297B522941C38241DA974DDA1A2E341AB02999B0E9C22BE969BBD269D28F5DD27B8DF67BD78057D7113322119B54CF9B335566338A67ED8A23654623091B1209D48551D47193E27144CC884468B8D0686FB1DE6FF2EF1DF20E121C0EDF9847DF8770F787DC9D41DC837CFF83182830186ABED46AEECB25EE9952CB99817AFB8162A6C462365A6C362E725C2E7A8EF47AFEFB05FE45CF8A459C5DC19C759FEA75914ADB910C14180C0F111E0FE7D037E7F6E315F6143C281463A5C6631D273A1D0B1D160B8B64EF8BB32C9FB3F3EC1FF3B22F9DB23B4D763B081810084BDD964B10302010A613B5A632566432B9328BB9A801A9A8924FDD92F1EA1BF156FAAC56DD9E43DD21634221BF3887BF040C0804BE3B85BED68355D6FDFE03FD7799EE77EAC72DEA3A4E743AC8A169C88F68E78F57F9AE571E223C1EFAF70DFA2B7D562B58E8B058C5B673C527694E27AC0DA1ACE3DC3FE3EDCE23ED9740D797BB348FBB46CA8C46050F0A0540C0804031536231E5D633E537596E372C74582C9E5BC59E0A1E140AB12A9BB1B52693B5060A0C066CB4D86C1F213E1FA31CBFA32A7E542A7090E070FFF807FFBA378DBA07090E07246C4824163A2C16C6B375C661A3C261
EOF
)

# Function to log messages
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# Function to download new keys
download_new_keys() {
    log "Downloading new keys from: $KEYS_URL"

    # Prova con wget
    if wget -q --timeout=30 --tries=2 -O "/tmp/new_tivusat_keys.txt" "$KEYS_URL"; then
        if [ -s "/tmp/new_tivusat_keys.txt" ] && grep -q "rsakey" "/tmp/new_tivusat_keys.txt"; then
            log "New keys downloaded successfully with wget"
            cat "/tmp/new_tivusat_keys.txt"
            return 0
        fi
    fi
    # Prova con curl se wget fallisce
    if curl -s --connect-timeout 30 --max-time 60 -o "/tmp/new_tivusat_keys.txt" "$KEYS_URL"; then
        if [ -s "/tmp/new_tivusat_keys.txt" ] && grep -q "rsakey" "/tmp/new_tivusat_keys.txt"; then
            log "New keys downloaded successfully with curl"
            cat "/tmp/new_tivusat_keys.txt"
            return 0
        fi
    fi

    log "Failed to download new keys from online source"
    return 1
}

update_tivusat_system() {
    local new_keys="$1"

    log "Checking Tivusat reader status..."

    # Crea backup
    cp "$OSCAM_FILE" "$BACKUP_FILE"

    # Cerca reader Tivusat esistente
    local tivusat_line=$(get_tivusat_reader_info)

    if [ -n "$tivusat_line" ]; then
        log "Found existing Tivusat reader at line: $tivusat_line"
        update_existing_reader "$tivusat_line" "$new_keys"
    else
        log "No Tivusat reader found - checking for reader with caid 183E"

        # Cerca se esiste un reader con caid 183E ma senza chiavi
        local caid_183e_line=$(grep -n "caid.*183E" "$OSCAM_FILE" | head -1 | cut -d: -f1)

        if [ -n "$caid_183e_line" ]; then
            log "Found reader with caid 183E at line: $caid_183e_line - converting to Tivusat"
            convert_to_tivusat_reader "$caid_183e_line" "$new_keys"
        else
            log "No reader with caid 183E found - creating new Tivusat reader"
            create_new_tivusat_reader "$new_keys"
        fi
    fi
}

# Caso 1: Reader Tivusat esistente - aggiorna chiavi
update_existing_reader() {
    local start_line="$1"
    local new_keys="$2"
    log "Updating existing Tivusat reader..."
    awk -v start="$start_line" -v new_keys="$new_keys" '
    BEGIN {
        split(new_keys, key_lines, "\n")
        in_target=0
        processed=0
    }
    {
        if (NR < start) {
            print
            next
        }
        if (NR == start) {
            in_target=1
            print
            next
        }
        if (in_target && !processed) {
            # Salta le vecchie chiavi
            if (/rsakey[[:space:]]*=/ || /tiger_/) {
                next
            }
            # Quando troviamo una riga che non è una chiave, inseriamo le nuove chiavi
            if (!/rsakey[[:space:]]*=/ && !/tiger_/ && !/^[[:space:]]*$/) {
                # Inserisci tutte le nuove chiavi
                for (i in key_lines) {
                    if (key_lines[i] != "") print key_lines[i]
                }
                processed=1
            }
            print
            next
        }
        print
    }
    END {
        if (in_target && !processed) {
            # Se siamo alla fine e non abbiamo ancora inserito, aggiungi chiavi
            for (i in key_lines) {
                if (key_lines[i] != "") print key_lines[i]
            }
        }
    }
    ' "$OSCAM_FILE" > "${TEMP_FILE}_updated"

    mv "${TEMP_FILE}_updated" "$OSCAM_FILE"
}

# Caso 2: Reader con caid 183E ma non Tivusat - convertilo
# Caso 2: Reader con caid 183E ma non Tivusat - convertilo
convert_to_tivusat_reader() {
    local start_line="$1"
    local new_keys="$2"

    log "Converting existing reader to Tivusat..."

    # Trova la fine del reader
    local end_line=$(awk -v start="$start_line" '
        NR > start && /^\[reader\]/ { print NR-1; exit }
        END { print NR }
    ' "$OSCAM_FILE")

    awk -v start="$start_line" -v end="$end_line" -v new_keys="$new_keys" '
    BEGIN {
        split(new_keys, key_lines, "\n")
        in_target=0
        processed=0
    }
    {
        if (NR < start) {
            print
            next
        }
        
        if (NR == start && !in_target) {
            in_target=1
            # Modifica il label per renderlo Tivusat
            if ($0 ~ /label[[:space:]]*=/) {
                sub(/label[[:space:]]*=.*/, "label                         = Tivusat-183E")
            } else {
                # Se non c'è label, aggiungilo dopo [reader]
                if ($0 ~ /^\[reader\]/) {
                    print $0
                    print "label                         = Tivusat-183E"
                    next
                }
            }
            print
            next
        }
        
        if (in_target && !processed) {
            # Salta vecchie chiavi se esistono
            if ($0 ~ /rsakey[[:space:]]*=/ || $0 ~ /tiger_/) {
                next
            }

            # Dopo caid, inserisci le nuove chiavi
            if ($0 ~ /caid[[:space:]]*=/) {
                print
                # Aggiungi tutte le nuove chiavi
                for (i in key_lines) {
                    if (key_lines[i] != "") print key_lines[i]
                }
                processed=1
                next
            }

            # Se siamo alla fine del reader e non abbiamo ancora processato
            if (NR >= end) {
                # Aggiungi chiavi alla fine
                for (i in key_lines) {
                    if (key_lines[i] != "") print key_lines[i]
                }
                processed=1
            }
            
            print
            next
        }
        
        print
    }
    END {
        if (in_target && !processed) {
            # Se siamo alla fine del file e non abbiamo ancora inserito, aggiungi chiavi
            for (i in key_lines) {
                if (key_lines[i] != "") print key_lines[i]
            }
        }
    }
    ' "$OSCAM_FILE" > "${TEMP_FILE}_updated"

    mv "${TEMP_FILE}_updated" "$OSCAM_FILE"'
}

# Caso 3: Nessun reader 183E - creane uno nuovo
create_new_tivusat_reader() {
    local new_keys="$1"
    log "Creating new Tivusat reader..."
    # Crea il nuovo reader all'inizio del file
    local new_reader=$(cat << EOF
#################################################################
####################### Levi45 Protocol  ########################
#################################################################

[reader]
label                         = Tivusat-183E
description                   = Tivusat
protocol                      = internal
device                        = /dev/sci0
localcards                    = 183E:000000,005411
caid                          = 183E
$new_keys
detect                        = cd
nagra_read                    = 1
mhz                           = 500
ident                         = 183E:000000,005411
group                         = 1
emmcache                      = 0,3,2,0
ecmwhitelist                  = 91
ecmheaderwhitelist            = 80308ED387,81308ED387
EOF
)

    # Inserisci all'inizio del file
    echo "$new_reader" | cat - "$OSCAM_FILE" > "${TEMP_FILE}_new"
    mv "${TEMP_FILE}_new" "$OSCAM_FILE"
}
# Function to get hardcoded keys (FALLBACK)
get_hardcoded_keys() {
    cat << 'EOF'
rsakey                        = A22DE56CA2560B596E4B76DDFD1CFE7528F696E229B3A88B60CE6250287FBC0F62F62485D3FD8DA69B2C3C5B8A9E859608BB56169A0445180951D9F85EBC4D3EFA7F3B6181DDA069D6657B38A79784CD63AB8BAE9B9CADB48632E86600D7FC5D
rsakey_tiger                  = A22DE56CA2560B596E4B76DDFD1CFE7528F696E229B3A88B60CE6250287FBC0F62F62485D3FD8DA69B2C3C5B8A9E859608BB56169A0445180951D9F85EBC4D3EFA7F3B6181DDA069D6657B38A79784CD63AB8BAE9B9CADB48632E86600D7FC5D
tiger_save_emm                = 0
tiger_round_keys              = 3EA3BD0C849DFD990DFD37D24F7F42C15A8B3ED2E2DDBB5908218E16E0DAE1DD4BE7B5837D2D8876CBC6416620B47F63A547F9383DA948ECD61CCA32786F0F7B23D0D83100CECE192956A27E295E40A9DE342F8EEB12A4065EEA757A6326A67A
tiger_t0                      = BA5D5DE745DEDE9B0000000097B7B7205FD3D38C6DCACAA7783C3C441A0D0D177FC3C3BC09F8F8F16FCBCBA4E38D8D6EEC76769AEB898962ADAAAA0724121236E9888861442222669E4F4FD14FDBDB94DA6D6DB78E4747C931E4E4D5984C4CD4F0787888CD9A9A57924949DBDF93934C71C4C4B579C0C0B9F586867326131335ABA9A90240202060A65353F5381C1C249C4E4ED267CFCFA86A35355F7239394B91B4B425BBA1A11AA85454FCC86464AC0603030577C7C7B0F3858576B85C5CE4B65B5BED63CDCDAE49D8D891E4727296D5969643844242C689B8B8313BE1E1DABDA2A21FC06060A027EFEFC883BDBD3E04020206A7AFAF08E18C8C6DE6737395F87C7C84FE7F7F81BC5E5EE20BF9F9F2CA6565AF35E6E6D32FEBEBC4A3ADAD0EB45A5AEEB3A5A516F279798BE58E8E6B2A15153F6030305021ECECCDB1A4A4157DC2C2BF7C3E3E4239E0E0D9E874749CA25151F30FFBFBF45A2D2D77DC6E6EB2D19494459A4D4DD7AA5555FF6834345CA5AEAE0BA45252F6FC7E7E82C39D9D5E944A4ADE17F7F7E0F980807919F0F0E959D0D089D9909049B7A7A71029E8E8C1C79F9F58A05050F053D5D5865BD1D18AC998985161CCCCADB9A0A0192E17173911F4F4E595B6B6237BC1C1BA50282878BE5F5FE14C26266A02010103AFABAB044A25256F70383848FD82827FFA7D7D87904848D801FCFCFD361B1B2D65CECEAB7E3F3F41D66B6BBD3DE2E2DFCE6767A9CC6666AA864343C5B25959EB3219192BF18484757A3D3D4713F5F5E65E2F2F716BC9C9A281BCBC3D4BD9D992D39595465229297B824141C34DDADA97341A1A2E99B0B0292BE9E9C2D26969BB5DD2D28FF67B7B8D57D7D78022111133CF9B9B5466333355ED8A8A67462323651209091B51D4D485E2717193884444CCD06868B8DE6F6FB11DF2F2EF1C0E0E1247DFDF98F787877041DCDC9DFF83837C30181828D46A6ABE25EEEECBCB999952FB81817AC46262A66C36365A5C2E2E72F47A7A8E05FEFEFB8A4545CFC19C9C5DEA75759FDB91914A180C0C141E0F0F1137E7E7D015F6F6E32814143CC66363A53A1D1D27160B0B1DEF8B8B649FB3B32C1FF3F3EC9DB2B22F763B3B4D10080818964B4BDD20101030B5A6A613643232568BB9B932A9A8A801DD92924F1BF1F1EAAC5656FA43DDDD9E4221216387BFBF380804040C85BEBE3B55D6D68303FDFDFEEE7777992DEAEAC7743A3A4E69C8C8A1E78F8F68AE5757F93C1E1E220DFAFAF7562B2B7DB05858E873C5C5B64E272769A1ACAC0D3FE3E3DC23EDEDCED79797408FBBBB348C4646CA0A05050F804040C06231315333E5E5D66E373759582C2C74C59E9E5B140A0A1E9BB1B12A93B5B5260C06060AD86C6CB43E1F1F21BFA3A31C542A2A7EE070709007FFFFF88DBABA370E0707094824246C2C16163A75C6C6B3C26161A3
tiger_t1                      = 5D5DE7BADEDE9B4500000000B7B72097D3D38C5FCACAA76D3C3C44780D0D171AC3C3BC7FF8F8F109CBCBA46F8D8D6EE376769AEC898962EBAAAA07AD12123624888861E9222266444F4FD19EDBDB944F6D6DB7DA4747C98EE4E4D5314C4CD498787888F09A9A57CD4949DB9293934CDFC4C4B571C0C0B979868673F513133526A9A902AB202060405353F5A61C1C24384E4ED29CCFCFA86735355F6A39394B72B4B42591A1A11ABB5454FCA86464ACC803030506C7C7B077858576F35C5CE4B85B5BEDB6CDCDAE63D8D89149727296E4969643D54242C684B8B83189E1E1DA3BA2A21FBD6060A0C0EFEFC827BDBD3E8302020604AFAF08A78C8C6DE1737395E67C7C84F87F7F81FE5E5EE2BCF9F9F20B6565AFCAE6E6D335EBEBC42FADAD0EA35A5AEEB4A5A516B379798BF28E8E6BE515153F2A30305060ECECCD21A4A415B1C2C2BF7D3E3E427CE0E0D93974749CE85151F3A2FBFBF40F2D2D775A6E6EB2DC949445D14D4DD79A5555FFAA34345C68AEAE0BA55252F6A47E7E82FC9D9D5EC34A4ADE94F7F7E017808079F9F0F0E919D0D08959909049D9A7A710B7E8E8C1299F9F58C75050F0A0D5D58653D1D18A5B989851C9CCCCAD61A0A019B91717392EF4F4E511B6B62395C1C1BA7B282878505F5FE1BE26266A4C01010302ABAB04AF25256F4A3838487082827FFD7D7D87FA4848D890FCFCFD011B1B2D36CECEAB653F3F417E6B6BBDD6E2E2DF3D6767A9CE6666AACC4343C5865959EBB219192B32848475F13D3D477AF5F5E6132F2F715EC9C9A26BBCBC3D81D9D9924B959546D329297B524141C382DADA974D1A1A2E34B0B02999E9E9C22B6969BBD2D2D28F5D7B7B8DF6D7D78057111133229B9B54CF333355668A8A67ED2323654609091B12D4D48551717193E24444CC886868B8D06F6FB1DEF2F2EF1D0E0E121CDFDF9847878770F7DCDC9D4183837CFF181828306A6ABED4EEEECB25999952CB81817AFB6262A6C436365A6C2E2E725C7A7A8EF4FEFEFB054545CF8A9C9C5DC175759FEA91914ADB0C0C14180F0F111EE7E7D037F6F6E31514143C286363A5C61D1D273A0B0B1D168B8B64EFB3B32C9FF3F3EC1FB2B22F9D3B3B4D76080818104B4BDD9610103020A6A613B532325664B9B9328BA8A801A992924FDDF1F1EA1B5656FAACDDDD9E4321216342BFBF388704040C08BEBE3B85D6D68355FDFDFE03777799EEEAEAC72D3A3A4E74C8C8A1698F8F68E75757F9AE1E1E223CFAFAF70D2B2B7D565858E8B0C5C5B6732727694EACAC0DA1E3E3DC3FEDEDCE23979740D7BBBB348F4646CA8C05050F0A4040C08031315362E5E5D6333737596E2C2C74589E9E5BC50A0A1E14B1B12A9BB5B5269306060A0C6C6CB4D81F1F213EA3A31CBF2A2A7E54707090E0FFFFF807BABA378D0707090E24246C4816163A2CC6C6B3756161A3C2
tiger_t2                      = E7BA5D5D9B45DEDE000000002097B7B78C5FD3D3A76DCACA44783C3C171A0D0DBC7FC3C3F109F8F8A46FCBCB6EE38D8D9AEC767662EB898907ADAAAA3624121261E9888866442222D19E4F4F944FDBDBB7DA6D6DC98E4747D531E4E4D5984C4C88F0787857CD9A9ADB9249494CDF9393B571C4C4B979C0C073F586863526131302ABA9A960402020F5A6535324381C1CD29C4E4EA867CFCF5F6A35354B7239392591B4B41ABBA1A1FCA85454ACC8646405060303B077C7C776F38585E4B85C5CEDB65B5BAE63CDCD9149D8D896E4727243D59696C68442423189B8B8DA3BE1E11FBDA2A2A0C06060C827EFEF3E83BDBD0604020208A7AFAF6DE18C8C95E6737384F87C7C81FE7F7FE2BC5E5EF20BF9F9AFCA6565D335E6E6C42FEBEB0EA3ADADEEB45A5A16B3A5A58BF279796BE58E8E3F2A151550603030CD21ECEC15B1A4A4BF7DC2C2427C3E3ED939E0E09CE87474F3A25151F40FFBFB775A2D2DB2DC6E6E45D19494D79A4D4DFFAA55555C6834340BA5AEAEF6A4525282FC7E7E5EC39D9DDE944A4AE017F7F779F98080E919F0F08959D0D049D9909010B7A7A7C129E8E858C79F9FF0A050508653D5D58A5BD1D151C99898AD61CCCC19B9A0A0392E1717E511F4F42395B6B6BA7BC1C178502828E1BE5F5F6A4C26260302010104AFABAB6F4A2525487038387FFD828287FA7D7DD8904848FD01FCFC2D361B1BAB65CECE417E3F3FBDD66B6BDF3DE2E2A9CE6767AACC6666C5864343EBB259592B32191975F18484477A3D3DE613F5F5715E2F2FA26BC9C93D81BCBC924BD9D946D395957B522929C3824141974DDADA2E341A1A2999B0B0C22BE9E9BBD269698F5DD2D28DF67B7B8057D7D73322111154CF9B9B5566333367ED8A8A654623231B1209098551D4D485E27171CC884444B8D06868B1DE6F6FEF1DF2F2121C0E0E9847DFDF70F787879D41DCDC7CFF838328301818BED46A6ACB25EEEE52CB99997AFB8181A6C462625A6C3636725C2E2E8EF47A7AFB05FEFECF8A45455DC19C9C9FEA75754ADB919114180C0C111E0F0FD037E7E7E315F6F63C281414A5C66363273A1D1D1D160B0B64EF8B8B2C9FB3B3EC1FF3F32F9DB2B24D763B3B18100808DD964B4B3020101013B5A6A656643232328BB9B901A9A8A84FDD9292EA1BF1F1FAAC56569E43DDDD634221213887BFBF0C0804043B85BEBE8355D6D6FE03FDFD99EE7777C72DEAEA4E743A3AA169C8C868E78F8FF9AE5757223C1E1EF70DFAFA7D562B2BE8B05858B673C5C5694E27270DA1ACACDC3FE3E3CE23EDED40D79797348FBBBBCA8C46460F0A0505C080404053623131D633E5E5596E373774582C2C5BC59E9E1E140A0A2A9BB1B12693B5B50A0C0606B4D86C6C213E1F1F1CBFA3A37E542A2A90E07070F807FFFF378DBABA090E07076C4824243A2C1616B375C6C6A3C26161
tiger_t3                      = 5DE7BA5DDE9B45DE00000000B72097B7D38C5FD3CAA76DCA3C44783C0D171A0DC3BC7FC3F8F109F8CBA46FCB8D6EE38D769AEC768962EB89AA07ADAA123624128861E988226644224FD19E4FDB944FDB6DB7DA6D47C98E47E4D531E44CD4984C7888F0789A57CD9A49DB9249934CDF93C4B571C4C0B979C08673F58613352613A902ABA92060402053F5A6531C24381C4ED29C4ECFA867CF355F6A35394B7239B42591B4A11ABBA154FCA85464ACC86403050603C7B077C78576F3855CE4B85C5BEDB65BCDAE63CDD89149D87296E4729643D59642C68442B83189B8E1DA3BE1A21FBDA260A0C060EFC827EFBD3E83BD02060402Af08A7AF8C6DE18C7395E6737C84F87C7F81FE7F5EE2BC5EF9F20BF965AFCA65E6D335E6EBC42FEBAD0EA3AD5AEEB45AA516B3A5798BF2798E6BE58E153F2A1530506030ECCD21ECA415B1A4C2BF7DC23E427C3EE0D939E0749CE87451F3A251FBF40FFB2D775A2D6EB2DC6E9445D1944DD79A4D55FFAA55345C6834AE0BA5AE52F6A4527E82FC7E9D5EC39D4ADE944AF7E017F78079F980F0E919F0D08959D09049D990A710B7A7E8C129E89F58C79F50F0A050D58653D5D18A5BD19851C998CCAD61CCA019B9A017392E17F4E511F4B62395B6C1BA7BC1287850285FE1BE5F266A4C2601030201AB04AFAB256F4A2538487038827FFD827D87FA7D48D89048FCFD01FC1B2D361BCEAB65CE3F417E3F6BBDD66BE2DF3DE267A9CE6766AACC6643C5864359EBB259192B32198475F1843D477A3DF5E613F52F715E2FC9A26BC9BC3D81BCD9924BD99546D395297B522941C38241DA974DDA1A2E341AB02999B0E9C22BE969BBD269D28F5DD27B8DF67BD78057D7113322119B54CF9B335566338A67ED8A23654623091B1209D48551D47193E27144CC884468B8D0686FB1DE6FF2EF1DF20E121C0EDF9847DF8770F787DC9D41DC837CFF83182830186ABED46AEECB25EE9952CB99817AFB8162A6C462365A6C362E725C2E7A8EF47AFEFB05FE45CF8A459C5DC19C759FEA75914ADB910C14180C0F111E0FE7D037E7F6E315F6143C281463A5C6631D273A1D0B1D160B8B64EF8BB32C9FB3F3EC1FF3B22F9DB23B4D763B081810084BDD964B10302010A613B5A632566432B9328BB9A801A9A8924FDD92F1EA1BF156FAAC56DD9E43DD21634221BF3887BF040C0804BE3B85BED68355D6FDFE03FD7799EE77EAC72DEA3A4E743AC8A169C88F68E78F57F9AE571E223C1EFAF70DFA2B7D562B58E8B058C5B673C527694E27AC0DA1ACE3DC3FE3EDCE23ED9740D797BB348FBB46CA8C46050F0A0540C0804031536231E5D633E537596E372C74582C9E5BC59E0A1E140AB12A9BB1B52693B5060A0C066CB4D86C1F213E1FA31CBFA32A7E542A7090E070FFF807FFBA378DBA07090E07246C4824163A2C16C6B375C661A3C261
EOF
}

# Function to check if Tivusat reader exists and get its info
get_tivusat_reader_info() {

    awk '
    /^\[reader\]/ {
        in_reader=1
        reader_start=NR
        has_tivusat_label=0
        has_183e=0
    }
    in_reader {
        if (/label.*Tivusat/) has_tivusat_label=1
        if (/caid.*183E/) has_183e=1



        if (/^\[/ && NR > reader_start) {
            if (has_tivusat_label && has_183e) {
                print reader_start
                exit
            }
            in_reader=0

        }
    }
    END {
        if (in_reader && has_tivusat_label && has_183e) {
            print reader_start
        }
    }
    ' "$OSCAM_FILE"
}

# Function to update ALL keys in Tivusat reader
update_tivusat_keys() {
    local start_line=$1
    local CURRENT_KEYS="$2"

    log "Updating ALL keys in Tivusat reader at line $start_line"

    # Find the end of this reader section
    local end_line=$(awk -v start="$start_line" '
        NR > start && /^\[reader\]/ { print NR-1; exit }
        END { print NR }
    ' "$OSCAM_FILE")

    # Create backup
    cp "$OSCAM_FILE" "$BACKUP_FILE"
    log "Backup created: $BACKUP_FILE"

    # Create new file - replace entire Tivusat reader section
    awk -v start="$start_line" -v end="$end_line" -v new_keys="$CURRENT_KEYS" '
        BEGIN {
            split(new_keys, keys_array, "\n")
        }
        NR < start {
            print
            next
        }
        NR == start {
            # Print the new Tivusat reader section
            print "#################################################################"
            print "####################### Levi45 Protocol  ########################"
            print "#################################################################"
            print ""
            print "[reader]"
            print "label                         = Tivusat-183E"
            print "description                   = Tivusat"
            print "protocol                      = internal"
            print "device                        = /dev/sci0"
            print "localcards                    = 183E:000000,005411"
            print "caid                          = 183E"

            # Print all the keys
            for (i in keys_array) {
                if (keys_array[i] != "") {
                    print keys_array[i]
                }
            }
            print "detect                        = cd"
            print "nagra_read                    = 1"
            print "mhz                           = 500"
            print "ident                         = 183E:000000,005411"
            print "group                         = 1"
            print "emmcache                      = 0,3,2,0"
            print "ecmwhitelist                  = 91"
            print "ecmheaderwhitelist            = 80308ED387,81308ED387"
            print ""

            # Skip the old section
            skip_section=1
            next
        }
        NR > start && NR <= end && skip_section {
            next
        }
        NR > end {
            print
        }
    ' "$OSCAM_FILE" > "${TEMP_FILE}_updated"

    # Check if the update was successful
    if grep -q "rsakey" "${TEMP_FILE}_updated"; then
        mv "${TEMP_FILE}_updated" "$OSCAM_FILE"
        log "All Tivusat keys updated successfully"
        return 0
    else
        log "Error: Key update failed - new keys not found in output"
        return 1
    fi
}

# Function to add new Tivusat reader with all keys
add_new_tivusat_reader() {
    local CURRENT_KEYS="$1"

    log "Adding new Tivusat reader section with all keys..."

    # Create backup
    cp "$OSCAM_FILE" "$BACKUP_FILE"

    # Add the new reader section at the beginning
    {
        echo "#################################################################"
        echo "####################### Levi45 Protocol  ########################"
        echo "#################################################################"
        echo ""
        echo "[reader]"
        echo "label                         = Tivusat-183E"
        echo "description                   = Tivusat"
        echo "protocol                      = internal"
        echo "device                        = /dev/sci0"
        echo "localcards                    = 183E:000000,005411"
        echo "caid                          = 183E"
        echo "$CURRENT_KEYS"
        echo "detect                        = cd"
        echo "nagra_read                    = 1"
        echo "mhz                           = 500"
        echo "ident                         = 183E:000000,005411"
        echo "group                         = 1"
        echo "emmcache                      = 0,3,2,0"
        echo "ecmwhitelist                  = 91"
        echo "ecmheaderwhitelist            = 80308ED387,81308ED387"
        echo ""
        cat "$OSCAM_FILE"
    } > "${TEMP_FILE}_new"

    mv "${TEMP_FILE}_new" "$OSCAM_FILE"
    log "New Tivusat reader added successfully with all keys"
}

# Main script
main() {
    log "Starting OSCam Tivusat Keys Update..."

    # Create backup directory
    mkdir -p "$BACKUP_DIR"

    # Prova a scaricare le nuove chiavi
    local CURRENT_KEYS
    if download_new_keys; then
        CURRENT_KEYS=$(cat "/tmp/new_tivusat_keys.txt")
        log "Using downloaded keys"
    else
        CURRENT_KEYS=$(get_hardcoded_keys)
        log "Using hardcoded keys"
    fi
    update_tivusat_system "$CURRENT_KEYS"

    # Check if oscam.server exists
    if [ ! -f "$OSCAM_FILE" ]; then
        log "Error: $OSCAM_FILE not found!"
        echo "ERROR: OSCam configuration file not found!"
        exit 1
    fi

    # Check if file is writable
    if [ ! -w "$OSCAM_FILE" ]; then
        log "Error: $OSCAM_FILE is not writable!"
        echo "ERROR: OSCam configuration file is not writable!"
        exit 1
    fi

    log "OSCam file found: $OSCAM_FILE"

    # Step 1: Check if Tivusat reader already exists
    local tivusat_line=$(get_tivusat_reader_info)

    if [ -n "$tivusat_line" ]; then
        log "Found existing Tivusat reader at line: $tivusat_line"
        if update_tivusat_keys "$tivusat_line" "$CURRENT_KEYS"; then
            echo "SUCCESS: All Tivusat keys updated in existing reader"
        else
            echo "ERROR: Failed to update Tivusat keys"
            exit 1
        fi
    else
        log "No Tivusat reader found - adding new one"
        add_new_tivusat_reader "$CURRENT_KEYS"
        echo "SUCCESS: New Tivusat reader added with all keys"
    fi

    # Set correct permissions
    chmod 644 "$OSCAM_FILE"

    log "Script completed successfully"
    echo "Backup created: $BACKUP_FILE"
    echo "Log file: $LOG_FILE"

    # Restart OSCam to apply changes
    log "Restarting OSCam to apply changes..."
    if pgrep -x "oscam" > /dev/null; then
        pkill -x oscam
        sleep 2
        # Restart oscam in background
        oscam -b -c /etc/tuxbox/config &
        log "OSCam restarted"
    fi
}

# Run main function
main "$@"